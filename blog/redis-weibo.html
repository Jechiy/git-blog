<!DOCTYPE html>
<html lang="zh-CN" class="no-js">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width">
	<meta name="keywords" content="redis,微博,关注,NoSQL开发,离离鸟">
	<meta name="description" content="由于产品需求的需要，我们做的产品里要实现类似微博里的关注关系。在过去的一篇博客《用MySQL实现微博关注关系的方案分析》分析了MySQL实现方式以及优缺点，这篇博客介绍Redis的实现思路。">

	<!--[if lt IE 9]>
	<script src="/theme/default/js/html5.js"></script>
	<![endif]-->
	<script>(function(html){html.className = html.className.replace(/\bno-js\b/,'js')})(document.documentElement);</script>
	
	<title>用redis实现微博关注关系|离离鸟</title>
	
	<link rel="stylesheet" href="/theme/default/css/genericons.css?ver=1.0" type="text/css" media="all" />
	<link rel="stylesheet" href="/theme/default/css/style.css?ver=1.0" type="text/css" media="all" />
	<link rel="stylesheet" href="/theme/default/css/markdown.css?ver=1.0" type="text/css" media="all" />
	<link rel="alternate" type="application/rss+xml" title="离离鸟" href="//feed.xml" />
	<!--[if lt IE 9]>
	<link rel="stylesheet" href="/theme/default/css/ie.css?ver=1.0" type="text/css" media="all" />
	<![endif]-->
	<!--[if lt IE 8]>
	<link rel="stylesheet" href="/theme/default/css/ie7.css?ver=1.0" type="text/css" media="all" />
	<![endif]-->
	
	<script type="text/javascript" src="/theme/default/js/jquery/jquery.js?ver=1.0"></script>
	<script type="text/javascript" src="/theme/default/js/jquery/jquery-migrate.min.js?ver=1.0"></script>
	
	<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?2703fc1521f461981b9b79a76cfd2f5d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
	
</head>

<body>
<div id="page" class="hfeed site">
	<a class="skip-link screen-reader-text" href="#content">Skip to content</a>
	
	    <div id="sidebar" class="sidebar">
	<header id="masthead" class="site-header" role="banner">
		<div class="site-branding">
			<h1 class="site-title"><a href="/" rel="home">离离鸟</a></h1>
				<p class="site-description">追着逝去的梦、向远方!</p>
				<button class="secondary-toggle">菜单和挂件</button>
		</div><!-- .site-branding -->
	</header><!-- .site-header -->
	<div id="secondary" class="secondary">
		<div id="widget-area" class="widget-area" role="complementary">
		
			<aside id="categories" class="widget widget_categories">
    <h2 class="widget-title">分类目录</h2>
    <ul>
                <li class="cat-item"><a href="/category/1085653296.html" >laravel</a></li>
                <li class="cat-item"><a href="/category/107260689.html" >GitBlog</a></li>
                <li class="cat-item"><a href="/category/511790939.html" >Sphinx</a></li>
                <li class="cat-item"><a href="/category/1460001917.html" >MySQL数据库</a></li>
                <li class="cat-item"><a href="/category/1703341873.html" >Linux服务器</a></li>
                <li class="cat-item"><a href="/category/1806945563.html" >mysql</a></li>
                <li class="cat-item"><a href="/category/1862565854.html" >NoSQL开发</a></li>
            </ul>
</aside>
		    <aside class="widget widget_archive">
    <h2 class="widget-title">文章归档</h2>
    <ul>
        <li><a href="/archive/201509.html">2015-09</a></li>
        <li><a href="/archive/201507.html">2015-07</a></li>
        <li><a href="/archive/201511.html">2015-11</a></li>
        <li><a href="/archive/201508.html">2015-08</a></li>
        </ul>
</aside>
		    <aside id="recent-posts" class="widget widget_recent_entries">
    <h2 class="widget-title">近期文章</h2>
    <ul>
        <li><a href="/blog/beian.html">域名在备案、好想体验下CDN的感觉</a></li>
        <li><a href="/blog/welcome.html">体验GitBlog</a></li>
        <li><a href="/blog/mysql-start-stop.html">如何启动/停止/重启MySQL服务</a></li>
        <li><a href="/blog/netstat.html">netstat命令的基本用法</a></li>
        <li><a href="/blog/mmseg.html">coreseek中mmseg词库的导入方法</a></li>
        </ul>
</aside>
		    <aside id="tag_cloud" class="widget widget_tag_cloud">
    <h2 class="widget-title">标签</h2>
    <div class="tagcloud">
        <a href="/tags/857322635.html" title="笔记" >笔记</a>
        <a href="/tags/107260689.html" title="GitBlog" >GitBlog</a>
        <a href="/tags/1236603860.html" title="博客" >博客</a>
        <a href="/tags/1739258616.html" title="静态" >静态</a>
        <a href="/tags/990660477.html" title="blade" >blade</a>
        <a href="/tags/124843.html" title="coreseek" >coreseek</a>
        <a href="/tags/511790939.html" title="Sphinx" >Sphinx</a>
        <a href="/tags/765534140.html" title="搜索引擎" >搜索引擎</a>
        <a href="/tags/859299063.html" title="InnoDB" >InnoDB</a>
        <a href="/tags/372942743.html" title="MySQL" >MySQL</a>
        <a href="/tags/57395030.html" title="内存管理" >内存管理</a>
        <a href="/tags/2029238744.html" title="脏页" >脏页</a>
        <a href="/tags/1845327201.html" title="双写缓冲" >双写缓冲</a>
        <a href="/tags/738693143.html" title="数据库" >数据库</a>
        <a href="/tags/432008716.html" title="表空间" >表空间</a>
        <a href="/tags/1775456038.html" title="mmseg" >mmseg</a>
        <a href="/tags/1332737870.html" title="Mosquitto" >Mosquitto</a>
        <a href="/tags/472249346.html" title="服务器" >服务器</a>
        <a href="/tags/1203904068.html" title="ACID" >ACID</a>
        <a href="/tags/1917151689.html" title="源码" >源码</a>
        <a href="/tags/1806945563.html" title="mysql" >mysql</a>
        <a href="/tags/1752954334.html" title="Linux" >Linux</a>
        <a href="/tags/1247123370.html" title="redis" >redis</a>
        <a href="/tags/1207068044.html" title="计数器" >计数器</a>
        <a href="/tags/1419996455.html" title="微博" >微博</a>
        <a href="/tags/1820957533.html" title="关注" >关注</a>
        <a href="/tags/1683366557.html" title="关注关系" >关注关系</a>
        </div>
</aside>
		    <aside id="text" class="widget widget_text">
    <h2 class="widget-title">介绍</h2>	
    <div class="textwidget">
    	<p>起笔难落，下笔有情；情牵何处，何处有愁思；如果不是有因为的因为，也不会有所以的所以；！</p>
    </div>
</aside>
	    </div><!-- .widget-area -->
    </div><!-- .secondary -->
</div><!-- .sidebar -->  
	    <div id="content" class="site-content">
    <div id="primary" class="content-area">
        <main id="main" class="site-main" role="main">
        
            <article class="post hentry">
<header class="entry-header">
    <h1 class="entry-title">用redis实现微博关注关系</h1>
</header><!-- .entry-header -->
<div class="entry-content">
<!--
author: jockchou
date: 2015-07-23
title: 用redis实现微博关注关系
tags: redis,微博,关注
category: NoSQL开发
status: publish
summary:由于产品需求的需要，我们做的产品里要实现类似微博里的关注关系。在过去的一篇博客《用MySQL实现微博关注关系的方案分析》分析了MySQL实现方式以及优缺点，这篇博客介绍Redis的实现思路。
-->
<p>由于产品需求的需要，我们做的产品里要实现类似微博里的关注关系。在过去的一篇博客《用MySQL实现微博关注关系的方案分析》分析了MySQL实现方式以及优缺点，这篇博客介绍Redis的实现思路。</p>
<h2 id="关注关系产生的四种关系状态">关注关系产生的四种关系状态</h2>
<ul>
<li>关注</li>
<li>粉丝</li>
<li>双向关注(互粉)</li>
<li>无关系 </li>
</ul>
<h2 id="需求分析">需求分析</h2>
<p>在微博中，每一个用户都会有一个关注列表，一个粉丝列表。用户可以查看自己的关注，粉丝列表，也可以查看别人的关注，粉丝列表。并且，要展示列表里每个人与当前查看者的关注状态。状态的可能性就是上面讲到得四种关系状态。</p>
<p>问题可以分两种情况来看：</p>
<ol>
<li>看自己的关注，粉丝列表</li>
<li>看别人的关注，粉丝列表</li>
</ol>
<h3 id="看自己的关注，粉丝列表：">看自己的关注，粉丝列表：</h3>
<p>这种情况相对简单一点。比如看自己的关注列表，列表里的人的与自己的关系状态不可能是“无关系”和“粉丝”。只可能是“关注”和“双向关注”。同样，粉丝列表也只有两种状态。</p>
<h3 id="看别人的关注，粉丝列表：">看别人的关注，粉丝列表：</h3>
<p>这是最复杂的情况，假如看别人关注列表，列表里的人和自己可能有上述全部四种关系状态。</p>
<h2 id="从集合的图来分析">从集合的图来分析</h2>
<p><img src="../img/4.png" alt="关注关系集合图" /></p>
<p>如上图所示。左边的圆表示用户的关注列表，右边的圆表示粉丝列表，下边的圆表示的是要查看的列表（集合）。分别用follow, fans, find来表明这三个集合。</p>
<p>当查看自己的列表时，其实表示find集合是上面集合中某一个的子集。例如查看自己粉丝，表示find是fans的子集，查看自己的关注，表示find是follow的子集。</p>
<p>查看别人的列表时，此时图中产生了三个集合的交集。要查询集合中的用户可能是在你的粉丝，关注集合中，也可能不在。就是说可能是任何一种关系状态，问题的根本就是，我们要计算出每一个用户与当前用户的关系状态。要求解四种关系状态，我们必然要求出图中下部分的三个小交集。</p>
<ul>
<li>要查询的集合与我的互粉交集</li>
<li>要查询的集合与我的关注交集</li>
<li>要查询的集的与我的粉丝交集</li>
</ul>
<p>不在这三个小交集中的用户就是无关系状态的用户。</p>
<p>假如我们采用如下一套命名:</p>
<blockquote>
<p>关注集合<br />
follow:userID</p>
<p>粉丝集合<br />
fans:userID</p>
<p>互粉集合(临时)<br />
fofa:userID</p>
<p>要查询的集合(临时)<br />
find:userID</p>
<p>要查询的集合与我的关注交集(临时)<br />
find_inter_follow:userID  </p>
<p>要查询的集的与我的粉丝交集(临时)<br />
find_inter_fans:userID</p>
<p>要查询的集合与我的互粉交集(临时)<br />
find_inter_fofa:userID</p>
<p>find中其他就是未关注</p>
</blockquote>
<h2 id="使用Sorted Set存储关系">使用Sorted Set存储关系</h2>
<p>score用来存储关注的时间，每个用户存储两个集合。follow:userID存储用户的关注，fans:userID存储用户的粉丝。于是我们可以设计一个函数来求出这些状态的集合。</p>
<p>函数返回：</p>
<pre><code>"findSet" =&gt; $findSet, //要查询的集合
"fofaSet" =&gt; $fofaSet, //互粉的集合
"findInterFollowSet" =&gt; $findInterFollowSet, //要查询的集合与我的关注交
"findInterFansSet" =&gt; $findInterFansSet //要查询的集的与我的粉丝交</code></pre>
<p>求出以上四个集合，就可以进行关系状态判断，先判断是否互粉，如果不是互粉，再判断是否是我关注的，如果不是，再判断是否是我的粉丝。如果都不是就是无关系。这样就能把状态求出来了。</p>
<pre><code>/*
* userID:当前用户id
* targetUserID: 被查看的人的id
* findType: 查看的是哪个列表
* findStart: 分页查看的列表开始的位置
* findEnd: 分页查看的列表结束的位置
*/
function getChunkSets($redis, $userID, $targetUserID, $findType, $findStart, $findEnd) {

        $fansKey = "fans:" . $userID;
        $followKey = "follow:" . $userID;
        $findKey = "find:" . $userID;

        $targetKey =  $findType. ":" . $targetUserID;
        $fofaKey = "find_inter_fofa:" . $userID;

        $findInterFollowKey = "find_inter_follow:" . $userID;
        $findInterFansKey = "find_inter_fans:" . $userID;

        //找出要查询的集合元素
        $findSet = $redis-&gt;zRevRange($targetKey, $findStart, $findEnd, TRUE);

        //要查询的集合与我的关注交
        $findInterFollowSet = array();

        //要查询的集的与我的粉丝交
        $findInterFansSet = array();

        //先清掉临时集合
        $redis-&gt;del($findKey);

        $redis-&gt;del($fofaKey);
        $redis-&gt;del($findInterFollowKey);
        $redis-&gt;del($findInterFansKey);

        //存起来
        foreach ($findSet as $uid =&gt; $score) {
            $redis-&gt;zAdd($findKey, $score, $uid);
        }

        //求互粉集合
        if ($userID != $targetUserID) { //看别人
            $redis-&gt;zInter($fofaKey, array($findKey, $fansKey, $followKey));

            /*
             * 如果不是看自己的列表，还要求
             * 1： 要查询的集合与我的关注交
             * 2： 要查询的集的与我的粉丝交
             */
            $redis-&gt;zInter($findInterFollowKey, array($findKey, $followKey));
            $redis-&gt;zInter($findInterFansKey, array($findKey, $fansKey));

            $findInterFollowSet = $redis-&gt;zRevRange($findInterFollowKey, 0, -1);
            $findInterFansSet = $redis-&gt;zRevRange($findInterFansKey, 0, -1);

        } else {
            if ($findType == "fans") { //自己看粉丝列表
                $redis-&gt;zInter($fofaKey, array($findKey, $followKey));
            } else if ($findType == "follow") { //看自己关注列表
                $redis-&gt;zInter($fofaKey, array($findKey, $fansKey));
            }
        }

        //互粉集合
        $fofaSet = $redis-&gt;zRevRange($fofaKey, 0, -1);

        return array(
            "findSet" =&gt; $findSet, //要查询的集合
            "fofaSet" =&gt; $fofaSet, //互粉的集合
            "findInterFollowSet" =&gt; $findInterFollowSet, //要查询的集合与我的关注交
            "findInterFansSet" =&gt; $findInterFansSet //要查询的集的与我的粉丝交
        );
    }</code></pre>
<p>以上函数已经求出了所需要的集合，然后就是关系状态判断了。</p>
<pre><code>/*
* isSelf: 是否查看自己的列表
* findType: 查看的是粉丝还是关注列表 1： 关注， 2: 粉丝
* userInfoArr: 用户详细信息数组
*/
function getUserInfoList($isSelf, $findType, $userInfoArr, $findSet, $fofaSet, $interFansSet, $interFollowSet) {

        $userInfoList = array();

        foreach($findSet as $userID =&gt; $favoTime) {
            if(!in_array($userID, array_keys($userInfoArr))) continue;

            $userInfo = new UserInfo($userInfoArr[$userID]);
            $userInfo = $userInfo-&gt;format();

            if(in_array($userID, $fofaSet)){
                $userInfo['favoFlag'] = 3; //互相关注
            } else {
                if($isSelf) {
                    $userInfo['favoFlag'] = $findType;
                } else {
                    if(in_array($userID, $interFansSet)) {
                        $userInfo['favoFlag'] = 2; //我的粉丝
                    } else if(in_array($userID, $interFollowSet)) {
                        $userInfo['favoFlag'] = 1; //我的关注
                    } else{
                        $userInfo['favoFlag'] = 0; //无关系
                    }
                }

            }

            $userInfo['favoTime'] = $favoTime;
            array_push($userInfoList, $userInfo);
        }

        return $userInfoList;
    }</code></pre>
</div><!-- .entry-content --><footer class="entry-footer">
	    <span class="posted-on">
        <span class="screen-reader-text">Posted on </span>
        <time class="entry-date published">2015-07-23</time>
    </span>
		
	    <span class="byline">
        <span class="author vcard">
            <span class="screen-reader-text">Author </span>
            jockchou
        </span>
    </span>
        
        <span class="cat-links">
        <span class="screen-reader-text">Categories </span>
          
           <a href="/category/1862565854.html" rel="category">NoSQL开发</a>
            </span>
        
    
        <span class="tags-links">
    	
        <span class="screen-reader-text">Tags </span>
          
           <a href="/tags/1247123370.html" rel="tag">redis</a>
          
           <a href="/tags/1419996455.html" rel="tag">微博</a>
          
           <a href="/tags/1820957533.html" rel="tag">关注</a>
            </span>
    </footer><!-- .entry-footer --></article><!-- #post-## -->            <div id="comments" class="comments-area">
	<div id="respond" class="comment-respond">
		<!-- 多说评论框 start -->
		<div class="ds-thread" data-thread-key="c139f31daa0d9f5735f082261804be41" data-title="用redis实现微博关注关系" data-url="//blog/redis-weibo.html"></div>
		<!-- 多说评论框 end -->
		<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
		<script type="text/javascript">
		var duoshuoQuery = {short_name:"ice-fire"};
		(function() {
			var ds = document.createElement('script');
			ds.type = 'text/javascript';ds.async = true;
			ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
			ds.charset = 'UTF-8';
			(document.getElementsByTagName('head')[0] 
			 || document.getElementsByTagName('body')[0]).appendChild(ds);
		})();
		</script>
        <!-- 多说公共JS代码 end -->
	</div><!-- #respond -->
</div><!-- .comments-area -->
            
        </main><!-- .site-main -->
    </div><!-- .content-area -->
</div><!-- .site-content -->	    <footer id="colophon" class="site-footer" role="contentinfo">
    <div class="site-info">
       
<center>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?fbe9a20bfe6ea4fe9f014a18deb04e7c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<br>
<a href="http://www.mmtrix.com" target="_blank"><img alt="mmtrix" src="http://s3.mmtrix.com/league/150-60.png"/></a>
</center>
 </div><!-- .site-info -->
</footer><!-- .site-footer -->
	
</div><!-- .site -->
<script type="text/javascript" src="/theme/default/js/skip-link-focus-fix.js?ver=1.0"></script>
<script type="text/javascript">
/* <![CDATA[ */
var screenReaderText = {"expand":"<span class=\"screen-reader-text\">\u5c55\u5f00\u5b50\u83dc\u5355<\/span>","collapse":"<span class=\"screen-reader-text\">\u6298\u53e0\u5b50\u83dc\u5355<\/span>"};
/* ]]> */
</script>
<script type="text/javascript" src="/theme/default/js/functions.js?ver=1.0"></script>
<link rel="stylesheet" href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css">
<script src="http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});</script>
<script type="text/javascript" src="http://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
