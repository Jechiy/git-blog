<!DOCTYPE html>
<html lang="zh-CN" class="no-js">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width">
	<meta name="keywords" content="coreseek,Sphinx,搜索引擎,离离鸟">
	<meta name="description" content="有这么一种常见的情况：整个数据集非常大，以至于难于经常性地重建索引，但是每次新增的记录却相对较少。一个典型的例子是：一个论坛有1000000个已经归档的帖子，但每天只有1000个新帖子。">

	<!--[if lt IE 9]>
	<script src="/theme/default/js/html5.js"></script>
	<![endif]-->
	<script>(function(html){html.className = html.className.replace(/\bno-js\b/,'js')})(document.documentElement);</script>
	
	<title>coreseek自动化增量索引配置|离离鸟</title>
	
	<link rel="stylesheet" href="/theme/default/css/genericons.css?ver=1.0" type="text/css" media="all" />
	<link rel="stylesheet" href="/theme/default/css/style.css?ver=1.0" type="text/css" media="all" />
	<link rel="stylesheet" href="/theme/default/css/markdown.css?ver=1.0" type="text/css" media="all" />
	<link rel="alternate" type="application/rss+xml" title="离离鸟" href="//feed.xml" />
	<!--[if lt IE 9]>
	<link rel="stylesheet" href="/theme/default/css/ie.css?ver=1.0" type="text/css" media="all" />
	<![endif]-->
	<!--[if lt IE 8]>
	<link rel="stylesheet" href="/theme/default/css/ie7.css?ver=1.0" type="text/css" media="all" />
	<![endif]-->
	
	<script type="text/javascript" src="/theme/default/js/jquery/jquery.js?ver=1.0"></script>
	<script type="text/javascript" src="/theme/default/js/jquery/jquery-migrate.min.js?ver=1.0"></script>
	
	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?fbe9a20bfe6ea4fe9f014a18deb04e7c";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>
	
</head>

<body>
<div id="page" class="hfeed site">
	<a class="skip-link screen-reader-text" href="#content">Skip to content</a>
	
	    <div id="sidebar" class="sidebar">
	<header id="masthead" class="site-header" role="banner">
		<div class="site-branding">
			<h1 class="site-title"><a href="/" rel="home">离离鸟</a></h1>
				<p class="site-description">追着逝去的梦、向远方!</p>
				<button class="secondary-toggle">菜单和挂件</button>
		</div><!-- .site-branding -->
	</header><!-- .site-header -->
	<div id="secondary" class="secondary">
		<div id="widget-area" class="widget-area" role="complementary">
		
			<aside id="categories" class="widget widget_categories">
    <h2 class="widget-title">分类目录</h2>
    <ul>
                <li class="cat-item"><a href="/category/1085653296.html" >laravel</a></li>
                <li class="cat-item"><a href="/category/511790939.html" >Sphinx</a></li>
                <li class="cat-item"><a href="/category/1460001917.html" >MySQL数据库</a></li>
                <li class="cat-item"><a href="/category/1703341873.html" >Linux服务器</a></li>
                <li class="cat-item"><a href="/category/1806945563.html" >mysql</a></li>
                <li class="cat-item"><a href="/category/1862565854.html" >NoSQL开发</a></li>
                <li class="cat-item"><a href="/category/107260689.html" >GitBlog</a></li>
            </ul>
</aside>
		    <aside class="widget widget_archive">
    <h2 class="widget-title">文章归档</h2>
    <ul>
        <li><a href="/archive/201511.html">2015-11</a></li>
        <li><a href="/archive/201509.html">2015-09</a></li>
        <li><a href="/archive/201507.html">2015-07</a></li>
        <li><a href="/archive/201508.html">2015-08</a></li>
        </ul>
</aside>
		    <aside id="recent-posts" class="widget widget_recent_entries">
    <h2 class="widget-title">近期文章</h2>
    <ul>
        <li><a href="/blog/welcome.html">体验GitBlog</a></li>
        <li><a href="/blog/mysql-start-stop.html">如何启动/停止/重启MySQL服务</a></li>
        <li><a href="/blog/netstat.html">netstat命令的基本用法</a></li>
        <li><a href="/blog/mmseg.html">coreseek中mmseg词库的导入方法</a></li>
        <li><a href="/blog/indexer.html">coreseek自动化增量索引配置</a></li>
        </ul>
</aside>
		    <aside id="tag_cloud" class="widget widget_tag_cloud">
    <h2 class="widget-title">标签</h2>
    <div class="tagcloud">
        <a href="/tags/857322635.html" title="笔记" >笔记</a>
        <a href="/tags/990660477.html" title="blade" >blade</a>
        <a href="/tags/124843.html" title="coreseek" >coreseek</a>
        <a href="/tags/511790939.html" title="Sphinx" >Sphinx</a>
        <a href="/tags/765534140.html" title="搜索引擎" >搜索引擎</a>
        <a href="/tags/859299063.html" title="InnoDB" >InnoDB</a>
        <a href="/tags/372942743.html" title="MySQL" >MySQL</a>
        <a href="/tags/57395030.html" title="内存管理" >内存管理</a>
        <a href="/tags/2029238744.html" title="脏页" >脏页</a>
        <a href="/tags/1845327201.html" title="双写缓冲" >双写缓冲</a>
        <a href="/tags/738693143.html" title="数据库" >数据库</a>
        <a href="/tags/432008716.html" title="表空间" >表空间</a>
        <a href="/tags/1775456038.html" title="mmseg" >mmseg</a>
        <a href="/tags/1332737870.html" title="Mosquitto" >Mosquitto</a>
        <a href="/tags/472249346.html" title="服务器" >服务器</a>
        <a href="/tags/1203904068.html" title="ACID" >ACID</a>
        <a href="/tags/1917151689.html" title="源码" >源码</a>
        <a href="/tags/1806945563.html" title="mysql" >mysql</a>
        <a href="/tags/1752954334.html" title="Linux" >Linux</a>
        <a href="/tags/1247123370.html" title="redis" >redis</a>
        <a href="/tags/1207068044.html" title="计数器" >计数器</a>
        <a href="/tags/1419996455.html" title="微博" >微博</a>
        <a href="/tags/1820957533.html" title="关注" >关注</a>
        <a href="/tags/1683366557.html" title="关注关系" >关注关系</a>
        <a href="/tags/107260689.html" title="GitBlog" >GitBlog</a>
        <a href="/tags/1236603860.html" title="博客" >博客</a>
        <a href="/tags/1739258616.html" title="静态" >静态</a>
        </div>
</aside>
		    <aside id="text" class="widget widget_text">
    <h2 class="widget-title">介绍</h2>	
    <div class="textwidget">
    	<p>起笔难落，下笔有情；情牵何处，何处有愁思；如果不是有因为的因为，也不会有所以的所以；！</p>
    </div>
</aside>
	    </div><!-- .widget-area -->
    </div><!-- .secondary -->
</div><!-- .sidebar -->  
	    <div id="content" class="site-content">
    <div id="primary" class="content-area">
        <main id="main" class="site-main" role="main">
        
            <article class="post hentry">
<header class="entry-header">
    <h1 class="entry-title">coreseek自动化增量索引配置</h1>
</header><!-- .entry-header -->
<div class="entry-content">
<!--
author: jockchou
date: 2015-08-25
title: coreseek自动化增量索引配置
tags: coreseek, Sphinx，搜索引擎
category: Sphinx
status: publish
summary: 有这么一种常见的情况：整个数据集非常大，以至于难于经常性地重建索引，但是每次新增的记录却相对较少。一个典型的例子是：一个论坛有1000000个已经归档的帖子，但每天只有1000个新帖子。
-->
<p>有这么一种常见的情况：整个数据集非常大，以至于难于经常性地重建索引，但是每次新增的记录却相对较少。一个典型的例子是：一个论坛有1000000个已经归档的帖子，但每天只有1000个新帖子。</p>
<p>在这种情况下可以用所谓的“主索引＋增量索引”（main+delta）模式来实现“近实时”的索引更新。这种方法的基本思路是设置两个数据源和两个索引，对很少更新或根本不更新的数据建立主索引，而对新增文档建立增量索引。在上述例子中，那1000000个已经归档的帖子放在主索引中，而每天新增的1000个帖子则放在增量索引中。增量索引更新的频率可以非常快，而文档可以在出现几分种内就可以被检索到。</p>
<p>确定具体某一文档的分属哪个索引的工作可以自动完成。一个可选的方案是，建立一个计数表，记录将文档集分成两部分的那个文档ID，而每次构建索引时，这个表都会被更新。</p>
<h2 id="增量索引配置">增量索引配置</h2>
<pre><code class="language-nginx">#定义subject主索引数据源
source pingo_subject_main
{
    type                    = mysql

    sql_host                = 127.0.0.1
    sql_user                = username
    sql_pass                = password
    sql_db                  = dbname
    sql_port                = 3306

    sql_query_pre           = SET NAMES utf8
    sql_query_pre           = SET SESSION query_cache_type = OFF

    sql_query_pre           = CREATE TABLE IF NOT EXISTS sph_counter(counter_id INTEGER PRIMARY KEY NOT NULL, max_doc_id INTEGER NOT NULL) DEFAULT CHARSET=utf8
    sql_query_pre           = REPLACE INTO sph_counter SELECT 2, MAX(id) FROM subject

    sql_query_range         = SELECT MIN(id), MAX(id) FROM subject WHERE id &lt;= (SELECT max_doc_id FROM sph_counter WHERE counter_id = 2)
    sql_range_step          = 1000
    sql_ranged_throttle     = 0

    sql_query               = SELECT id, id AS subjectid, title, content, imageUrl, imageUrl2, posterUrl, topicCnt, readCnt, userCnt, orderVal, isActivity, activityTitle, activityUrl, UNIX_TIMESTAMP(addTime) AS addTime, UNIX_TIMESTAMP(updateTime) AS updateTime, UNIX_TIMESTAMP(onlineTime) AS onlineTime, isOfficial, isHot, state FROM subject \
                              WHERE id &lt;= (SELECT max_doc_id FROM sph_counter WHERE counter_id = 2) \
                              AND id &gt;= $start AND id &lt;= $end

    sql_attr_uint           = subjectid
    sql_field_string        = title
    sql_attr_string         = content
    sql_attr_string         = imageUrl
    sql_attr_string         = imageUrl2
    sql_attr_string         = posterUrl
    sql_attr_uint           = topicCnt
    sql_attr_uint           = readCnt
    sql_attr_uint           = userCnt
    sql_attr_uint           = orderVal
    sql_attr_uint           = isActivity
    sql_attr_string         = activityTitle
    sql_attr_string         = activityUrl
    sql_attr_timestamp      = addTime
    sql_attr_timestamp      = updateTime
    sql_attr_timestamp      = onlineTime
    sql_attr_uint           = isOfficial
    sql_attr_uint           = isHot
    sql_attr_uint           = state

    sql_query_info          = SELECT id, title, content, state FROM subject WHERE id = $id
}

#定义subject增量索引数据源
source pingo_subject_delta : pingo_subject_main
{
    sql_query_pre           = SET NAMES utf8

    sql_query_post_index    = UPDATE sph_counter SET max_doc_id = $maxid WHERE counter_id = 2 AND $maxid &gt; 0

    sql_query_range         = SELECT MIN(id), MAX(id) FROM subject WHERE id &gt; (SELECT max_doc_id FROM sph_counter WHERE counter_id = 2)

    sql_query               = SELECT id, id AS subjectid, title, content, imageUrl, imageUrl2, posterUrl, topicCnt, readCnt, userCnt, orderVal, isActivity, activityTitle, activityUrl, UNIX_TIMESTAMP(addTime) AS addTime, UNIX_TIMESTAMP(updateTime) AS updateTime, UNIX_TIMESTAMP(onlineTime) AS onlineTime, isOfficial, isHot, state FROM subject \
                              WHERE id &gt; (SELECT max_doc_id FROM sph_counter WHERE counter_id = 2) \
                              AND id &gt;= $start AND id &lt;= $end
}

#subject主索引
index subject
{
    source                  = pingo_subject_main
    path                    = /usr/local/coreseek/var/data/subject
    docinfo                 = extern
    charset_dictpath        = /usr/local/mmseg3/etc
    charset_type            = zh_cn.utf-8
    ngram_len               = 0
}

#subject增量索引
index subject_delta
{
    source                  = pingo_subject_delta
    path                    = /usr/local/coreseek/var/data/subject_delta
    docinfo                 = extern
    charset_dictpath        = /usr/local/mmseg3/etc
    charset_type            = zh_cn.utf-8
    ngram_len               = 0
}
</code></pre>
<p>请注意，上例中我们显示设置了数据源pingo_subject_delta的sql_query_pre选项，覆盖了全局设置。必须显示地覆盖这个选项，否则对delta做索引的时候也会运行那条REPLACE查询，那样会导致delta源中选出的数据为空。可是简单地将delta的sql_query_pre设置成空也不行，因为在继承来的数据源上第一次运行这个指令的时候，继承来的所有值都会被清空，这样编码设置的部分也会丢失。因此需要再次显式调用编码设置查询。</p>
<p>通过以上配置以后，每次更新索引时，都会把数据源当前最大的id存储到sph_counter表中，下次更新索引，只是从这个位置开始，获取新增数据构建索引。</p>
<h2 id="构建主索引">构建主索引</h2>
<p>主索引在首次使用时构建，以后通过定时任务更新主索引，可以选择在系统压力小的时候更新主索引。</p>
<pre><code>/usr/local/coreseek/bin/indexer --rotate --quiet --config /usr/local/coreseek/etc/csft.conf subject </code></pre>
<h2 id="构建增量索引">构建增量索引</h2>
<p>增量索引地更新频率可以比较快一点，视系统的数据写入频率而定。</p>
<pre><code>/usr/local/coreseek/bin/indexer --rotate --quiet --config /usr/local/coreseek/etc/csft.conf subject_delta</code></pre>
<h2 id="合并索引">合并索引</h2>
<p>生成增量索引后，需要把它合并到主索引中，这样数据才能被查询到。可以在增量索引生成后，立即执行合并操作。</p>
<pre><code>/usr/local/coreseek/bin/indexer --rotate --quiet --config /usr/local/coreseek/etc/csft.conf --merge subject subject_delta</code></pre>
</div><!-- .entry-content --><footer class="entry-footer">
	    <span class="posted-on">
        <span class="screen-reader-text">Posted on </span>
        <time class="entry-date published">2015-08-25</time>
    </span>
		
	    <span class="byline">
        <span class="author vcard">
            <span class="screen-reader-text">Author </span>
            jockchou
        </span>
    </span>
        
        <span class="cat-links">
        <span class="screen-reader-text">Categories </span>
          
           <a href="/category/511790939.html" rel="category">Sphinx</a>
            </span>
        
    
        <span class="tags-links">
    	
        <span class="screen-reader-text">Tags </span>
          
           <a href="/tags/124843.html" rel="tag">coreseek</a>
          
           <a href="/tags/511790939.html" rel="tag">Sphinx</a>
          
           <a href="/tags/765534140.html" rel="tag">搜索引擎</a>
            </span>
    </footer><!-- .entry-footer --></article><!-- #post-## -->            <div id="comments" class="comments-area">
	<div id="respond" class="comment-respond">
		<!-- 多说评论框 start -->
		<div class="ds-thread" data-thread-key="226d2c60ea0ebc957508d2755ebf6196" data-title="coreseek自动化增量索引配置" data-url="//blog/indexer.html"></div>
		<!-- 多说评论框 end -->
		<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
		<script type="text/javascript">
		var duoshuoQuery = {short_name:"ice-fire"};
		(function() {
			var ds = document.createElement('script');
			ds.type = 'text/javascript';ds.async = true;
			ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
			ds.charset = 'UTF-8';
			(document.getElementsByTagName('head')[0] 
			 || document.getElementsByTagName('body')[0]).appendChild(ds);
		})();
		</script>
        <!-- 多说公共JS代码 end -->
	</div><!-- #respond -->
</div><!-- .comments-area -->
            
        </main><!-- .site-main -->
    </div><!-- .content-area -->
</div><!-- .site-content -->	    <footer id="colophon" class="site-footer" role="contentinfo">
    <div class="site-info">
       
<center>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?fbe9a20bfe6ea4fe9f014a18deb04e7c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<br>
<a href="http://www.mmtrix.com" target="_blank"><img alt="mmtrix" src="http://s3.mmtrix.com/league/150-60.png"/></a>
</center>
 </div><!-- .site-info -->
</footer><!-- .site-footer -->
	
</div><!-- .site -->
<script type="text/javascript" src="/theme/default/js/skip-link-focus-fix.js?ver=1.0"></script>
<script type="text/javascript">
/* <![CDATA[ */
var screenReaderText = {"expand":"<span class=\"screen-reader-text\">\u5c55\u5f00\u5b50\u83dc\u5355<\/span>","collapse":"<span class=\"screen-reader-text\">\u6298\u53e0\u5b50\u83dc\u5355<\/span>"};
/* ]]> */
</script>
<script type="text/javascript" src="/theme/default/js/functions.js?ver=1.0"></script>
<link rel="stylesheet" href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css">
<script src="http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});</script>
<script type="text/javascript" src="http://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
